{% extends "base.html" %}

{% block content %}
<div class="card">
    <h3>Input Data Tersangka Baru</h3>
    <form action="{{ url_for('add_case') }}" method="POST">
        <div class="form-grid">
            <div class="form-group">
                <label>Nama Tersangka</label>
                <input type="text" name="nama_tersangka" required>
            </div>
            <div class="form-group">
                <label>Umur Tersangka</label>
                <input type="number" name="umur_tersangka" min="0" placeholder="0">
            </div>
            <div class="form-group">
                <label>Kategori Umur</label>
                <select name="kategori_umur" class="form-select" required>
                    <option value="Dewasa">Dewasa</option>
                    <option value="Anak">Anak</option>
                </select>
            </div>
            <div class="form-group">
                <label>Pasal yang disangkakan</label>
                <input type="text" name="pasal" required>
            </div>
            <div class="form-group">
                <label>JPU</label>
                <input type="text" name="jpu">
            </div>
            <!-- SPDP Input Group -->
            <div style="grid-column: span 3; border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1rem;">
                <h4 style="margin: 0 0 1rem 0; color: #2c3e50;">Detail SPDP</h4>
                <div class="form-grid" style="grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                    <!-- Kejaksaan -->
                    <div class="form-group">
                        <label>Tgl Terima (Kejaksaan)</label>
                        <input type="date" name="spdp_tgl_terima" required>
                    </div>
                    <div class="form-group">
                        <label>Keterangan (Kejaksaan)</label>
                        <input type="text" name="spdp_ket_terima" placeholder="Keterangan...">
                    </div>
                    
                    <!-- Kepolisian -->
                    <div class="form-group">
                        <label>Tanggal SPDP</label>
                        <input type="date" name="spdp_tgl_polisi">
                    </div>
                    <div class="form-group">
                        <label>Nomor SPDP</label>
                        <input type="text" name="spdp_ket_polisi" placeholder="Nomor SPDP...">
                    </div>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn">Simpan Data</button>
        </div>
    </form>
</div>

<div class="card">
    <h3>Data Perkara</h3>
    
    <!-- Pagination Controls Top -->
    <div class="pagination-controls">
        <div class="per-page-selector">
            <label for="perPageSelect">Tampilkan:</label>
            <select id="perPageSelect" class="per-page-select">
                <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                <option value="30" {% if per_page == 30 %}selected{% endif %}>30</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            </select>
            <span class="per-page-label">data per halaman</span>
        </div>
        
        <div class="pagination-info">
            Menampilkan {{ ((pagination.page - 1) * pagination.per_page) + 1 }} - 
            {{ min(pagination.page * pagination.per_page, pagination.total) }} 
            dari {{ pagination.total }} data
        </div>
    </div>
    
    <div class="data-table-container">
        <table>
            <thead>
                <tr>
                    <th style="width: 50px;">NO</th>
                    <th>NAMA TERSANGKA</th>
                    <th>UMUR</th>
                    <th>KATEGORI</th>
                    <th>PASAL</th>
                    <th>JPU</th>
                    <th style="min-width: 220px;">SPDP<br><small>(KEJAKSAAN / POLISI)</small></th>
                    <th>BERKAS TAHAP I</th>
                    <th>P-18 / P-19</th>
                    <th>P-21</th>
                    <th>TAHAP II</th>
                    <th>LIMPAH PN</th>
                    <th>KETERANGAN</th>
                    <th style="width: 80px;">AKSI</th>
                </tr>
            </thead>
            <tbody>
                {% for case in cases %}
                <tr>
                    <td>{{ ((pagination.page - 1) * pagination.per_page) + loop.index }}</td>
                    <td class="editable" contenteditable="true" data-id="{{ case.id }}" data-field="nama_tersangka">{{ case.nama_tersangka }}</td>
                    <td class="editable" contenteditable="true" data-id="{{ case.id }}" data-field="umur_tersangka">{{ case.umur_tersangka or '' }}</td>
                    <td class="editable" contenteditable="true" data-id="{{ case.id }}" data-field="kategori_umur">{{ case.kategori_umur or 'Dewasa' }}</td>
                    <td class="editable" contenteditable="true" data-id="{{ case.id }}" data-field="pasal">{{ case.pasal }}</td>
                    <td class="editable" contenteditable="true" data-id="{{ case.id }}" data-field="jpu">{{ case.jpu or '' }}</td>
                    <!-- Improved SPDP Cell -->
                    <td class="date-cell {% if case.is_complete %}text-success-bold{% else %}{{ case.spdp_tgl_terima | check_overdue('spdp', case.kategori_umur or 'Dewasa') }}{% endif %}" 
                        data-id="{{ case.id }}" 
                        data-field="spdp_tgl_terima" 
                        data-value="{{ case.spdp_tgl_terima }}"
                        style="font-size: 0.85rem; line-height: 1.4;">
                        
                        <!-- Click to edit Kejaksaan Date (Primary) -->
                        <div style="margin-bottom: 6px;">
                            <span style="display:block; font-weight:bold; color:{% if case.is_complete %}#10b981{% else %}var(--primary-color){% endif %};">Kejaksaan:</span>
                            {% if case.spdp_tgl_terima %}
                                {{ case.spdp_tgl_terima }}
                            {% else %}
                                <span style="color:#999;">-</span>
                            {% endif %}
                            
                            {% if case.spdp_ket_terima %}
                            <br><small style="color:{% if case.is_complete %}#10b981{% else %}#666{% endif %};">Ket: {{ case.spdp_ket_terima }}</small>
                            {% endif %}
                        </div>
                        
                        <div style="border-top: 1px dashed #ddd; padding-top: 6px;">
                            <span style="display:block; font-weight:bold; color:{% if case.is_complete %}#10b981{% else %}var(--secondary-color){% endif %};">Tanggal SPDP:</span>
                             {% if case.spdp_tgl_polisi %}
                                {{ case.spdp_tgl_polisi }}
                            {% else %}
                                <span style="color:#999;">-</span>
                            {% endif %}

                            {% if case.spdp_ket_polisi %}
                            <br><small style="color:{% if case.is_complete %}#10b981{% else %}#666{% endif %};">Nomor: {{ case.spdp_ket_polisi }}</small>
                            {% endif %}
                        </div>
                    </td>
                    
                    <td class="date-cell {% if case.is_complete %}text-success-bold{% else %}{{ case.berkas_tahap_1 | check_overdue('berkas_tahap_1', case.kategori_umur or 'Dewasa') }}{% endif %}"
                        data-id="{{ case.id }}" 
                        data-field="berkas_tahap_1"
                        data-value="{{ case.berkas_tahap_1 }}">
                        {{ case.berkas_tahap_1 }}
                    </td>
                        
                    <td class="date-cell {% if case.is_complete %}text-success-bold{% else %}{{ case.p18_p19 | check_overdue('p18_p19', case.kategori_umur or 'Dewasa') }}{% endif %}"
                        data-id="{{ case.id }}" 
                        data-field="p18_p19"
                        data-value="{{ case.p18_p19 }}">
                        {{ case.p18_p19 }}
                    </td>
                        
                    <td class="date-cell {% if case.is_complete %}text-success-bold{% else %}{{ case.p21 | check_overdue('p21', case.kategori_umur or 'Dewasa') }}{% endif %}"
                        data-id="{{ case.id }}" 
                        data-field="p21"
                        data-value="{{ case.p21 }}">
                        {{ case.p21 }}
                    </td>
                        
                    <td class="date-cell {% if case.is_complete %}text-success-bold{% else %}{{ case.tahap_2 | check_overdue('tahap_2', case.kategori_umur or 'Dewasa') }}{% endif %}"
                        data-id="{{ case.id }}" 
                        data-field="tahap_2"
                        data-value="{{ case.tahap_2 }}">
                        {{ case.tahap_2 }}
                    </td>
                        
                    <td class="date-cell"
                        data-id="{{ case.id }}" 
                        data-field="limpah_pn"
                        data-value="{{ case.limpah_pn }}">
                        {{ case.limpah_pn }}
                    </td>
                    
                    <td contenteditable="true" 
                        class="editable" 
                        data-id="{{ case.id }}" 
                        data-field="keterangan">{{ case.keterangan }}</td>
                    <td style="text-align: center;">
                        <button class="btn-delete" 
                                data-id="{{ case.id }}" 
                                data-name="{{ case.nama_tersangka }}"
                                title="Hapus data">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination Controls Bottom -->
    <div class="pagination-wrapper">
        <div class="pagination">
            <!-- First Page -->
            {% if pagination.has_prev %}
            <a href="?page=1&per_page={{ per_page }}" class="pagination-btn">
                <span>¬´</span>
            </a>
            <a href="?page={{ pagination.prev_num }}&per_page={{ per_page }}" class="pagination-btn">
                <span>‚Äπ</span>
            </a>
            {% else %}
            <span class="pagination-btn disabled">¬´</span>
            <span class="pagination-btn disabled">‚Äπ</span>
            {% endif %}
            
            <!-- Page Numbers -->
            {% set start_page = [pagination.page - 2, 1]|max %}
            {% set end_page = [pagination.page + 2, pagination.pages]|min %}
            
            {% if start_page > 1 %}
            <a href="?page=1&per_page={{ per_page }}" class="pagination-btn">1</a>
            {% if start_page > 2 %}
            <span class="pagination-ellipsis">...</span>
            {% endif %}
            {% endif %}
            
            {% for p in range(start_page, end_page + 1) %}
            {% if p == pagination.page %}
            <span class="pagination-btn active">{{ p }}</span>
            {% else %}
            <a href="?page={{ p }}&per_page={{ per_page }}" class="pagination-btn">{{ p }}</a>
            {% endif %}
            {% endfor %}
            
            {% if end_page < pagination.pages %}
            {% if end_page < pagination.pages - 1 %}
            <span class="pagination-ellipsis">...</span>
            {% endif %}
            <a href="?page={{ pagination.pages }}&per_page={{ per_page }}" class="pagination-btn">{{ pagination.pages }}</a>
            {% endif %}
            
            <!-- Next Page -->
            {% if pagination.has_next %}
            <a href="?page={{ pagination.next_num }}&per_page={{ per_page }}" class="pagination-btn">
                <span>‚Ä∫</span>
            </a>
            <a href="?page={{ pagination.pages }}&per_page={{ per_page }}" class="pagination-btn">
                <span>¬ª</span>
            </a>
            {% else %}
            <span class="pagination-btn disabled">‚Ä∫</span>
            <span class="pagination-btn disabled">¬ª</span>
            {% endif %}
        </div>
    </div>
</div>

<!-- Date Picker Modal -->
<div id="dateModal" class="modal-overlay" style="display: none;">
    <div class="modal-card">
        <h3>Pilih Tanggal</h3>
        <input type="datetime-local" id="modalDateInput" class="modal-input">
        <div class="modal-actions">
            <button id="cancelDateBtn" class="btn btn-secondary">Batal</button>
            <button id="saveDateBtn" class="btn">Simpan</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal-overlay" style="display: none;">
    <div class="modal-card">
        <h3>Konfirmasi Hapus</h3>
        <p id="deleteMessage" style="margin: 1rem 0; color: #666;">Apakah Anda yakin ingin menghapus data ini?</p>
        <div class="modal-actions">
            <button id="cancelDeleteBtn" class="btn btn-secondary">Batal</button>
            <button id="confirmDeleteBtn" class="btn btn-danger">Hapus</button>
        </div>
    </div>
</div>
{% endblock %}

